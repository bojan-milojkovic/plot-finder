<!DOCTYPE html>
<html>
  <head>
	<title>Reading from database into Google Maps</title>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
	<meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
    
    <style>
      /* Always set the map height explicitly to define the size of the div
       * element that contains the map. */
      #map {
		position: absolute;
		top: 3px;
		left: 4px;
        height: 95%;
		width: 50%;
		align: left;
      }
	  #infowindow {
        height:100%;
		width: 50%;
		position: absolute;
		right: -6px;
		top: 0px;
		overflow-y: scroll;
      }
      /* Optional: Makes the sample page fill the window. */
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
	  body {
		position: relative;
	  }
	  th, td {
		text-align: left;
	  }
	  #descCell {
		position: absolute;
		left: 20px;
	  }
	  #searchDiv {
		left: 10px;
		top: 10px;
		background: white;
		position: absolute;
		align: bottom;
		z-index:2;
	  }
    </style>
	
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

  </head>
  <body>
    <div id="map"></div>
	<div id="infowindow">
		<table id="title">
			<tr><th>Title :</th><td id="titleCell"></td></tr>
			<tr><th>Description :</th></tr>
		</table>
		<div id="descCell">
		</div><br/>
		<table id="basicinfo">
			<tr><th>Address line 1 :</th><td id="add1Cell"></td></tr>
			<tr><th>Address line 2 :</th><td id="add2Cell"></td></tr>
			<tr><th>District :</th><td id="distCell"></td></tr>
			<tr><th>City :</th><td id="cityCell"></td></tr>
			<tr><th>Country :</th><td id="countryCell"></td></tr>
			<tr><th>Plot size : </th><td id="sizeCell"></td></tr>
			<tr><th>Price :</th><td id="priceCell"></td></tr>
			<tr><th>Plot is for </th><td id="typeCell"></td><tr>
		</table><br/>
		<table id="aditionalInfo" class="unchanging">
			<tr><th><input type="checkbox" id="house"/> Plot has a house</th><th><input type="checkbox" id="garage"/> Plot has a garage</th></tr>
			<tr><th><input type="checkbox" id="power"/> Plot has power</th><th><input type="checkbox" id="internet"/> Plot has internet</th></tr>
			<tr><th><input type="checkbox" id="sewer"/> Plot has sewer</th></tr>
			<tr><th><input type="checkbox" id="water"/> Plot has water</th></tr>
			<tr><th><input type="checkbox" id="gas"/> Plot has gas station/gas line near by</th></tr>
			<tr><th><input type="checkbox" id="farming"/> Plot is for farming</th></tr>
			<tr><th><input type="checkbox" id="grazing"/> Plot is for grazing</th></tr>
			<tr><th><input type="checkbox" id="orchard"/> Plot is an orchard</th></tr>
		</table>
	</div>
	<div id="searchDiv">
		<p>Find plots by :</p><br/>
		<table id="searchTable">
			<tr><td>Min price = <input type="text" id="minPrice"/></td><td>Max price = <input type="text" id="maxPrice"/></td></tr>
			<tr><td>Min size = <input type="text" id="minSize"/></td><td>Max size = <input type="text" id="maxSize"/></td></tr>
			<tr><td><input type="button" id="filter" value="Filter" onClick="filterPlots();"/></td></tr>
		</table>
	</div>
    <script>
		var json;
		var map;
		var polygons = [];
		var plots = [];
		
		
		function initMap(){
			//$('#searchDiv').hide();
			
			map = new google.maps.Map(document.getElementById('map'), {
				center: new google.maps.LatLng(-33.863276, 151.207977),
				zoom: 15
			});
					
			plots = JSON.parse(getPlots()).plots;
			
			createPolygons();
		}
		
		function reDrawPolygons(filteredPlotIds){
			polygons.forEach(function(polygon){
				if(polygon.plotId in filteredPlotIds){
					polygon.setMap(map);
				} else {
					polygon.setMap(null);
				}
			});
		}
		
		function validNumber(numValue){
			return numValue!==undefined && !isNaN(numValue) && typeof(numValue)==='number' && numValue>0;
		}
		
		function filterPlots(){
			var filteredPlotIds = [];
		
			var minSize = $('#minSize').val();
			var maxSize = $('#maxSize').val();
			
			plots
			.filter(function(plot){
				return validNumber(minSize) && plot.size>=minSize;
			})
			.filter(function(plot){
				return validNumber(maxSize) && plot.size<=maxSize;
			})
			.forEach(function(plot){
				filteredPlotIds.push(plot.id);
			});
			
			if(filteredPlotIds.length){
				reDrawPolygons(filteredPlotIds);
			}
		}
		
		function createPolygons(){
			plots.forEach(function(plot, index) {
				var polygon = new google.maps.Polygon({
						pIndex: index,
						plotId: plot.id,
						paths: plot.vertices,
						strokeColor: '#FF0000',
						strokeOpacity: 0.8,
						strokeWeight: 2,
						fillColor: '#FF0000',
						fillOpacity: 0.35
					});
				polygon.setMap(map);
				
				var marker = new google.maps.Marker({
						position: plot.vertices[0],
						map: map,
						title: plot.title,
						label: customLabel[plot.type].label
					});
				
				polygon.addListener('click', function(){
					resetStrokes();
					this.setOptions({strokeWeight: 6});
					fillPlotInfo(plots[index]);
				});
				
				polygons.push(polygon);
			});
		}
		
		function resetStrokes(){
			polygons.forEach(function(polygon, index) {
				polygon.setOptions({strokeWeight: 2});
			});
		}
		
		function fillPlotInfo(plot){
			$('#aditionalInfo input[type=checkbox]').prop('checked', false);
		
			$('#titleCell').text(plot.title);
			$('#descCell').text(plot.description);
			$('#add1Cell').text(plot.address1);
			$('#add2Cell').text(plot.address2);
			$('#distCell').text(plot.district);
			$('#cityCell').text(plot.city);
			$('#countryCell').text(plot.country);
			$('#priceCell').text(plot.price + '  ' + plot.currency);
			$('#sizeCell').text(plot.size + '  ' + plot.sizeUnit);
			$('#typeCell').text(plot.type);
				
			$('#house').prop('checked', plot.house);
			$('#power').prop('checked', plot.power);
			$('#water').prop('checked', plot.water);
			$('#sewer').prop('checked', plot.sewer);
			
			$('#gas').prop('checked', plot.gas);
			$('#internet').prop('checked', plot.internet);
			$('#garage').prop('checked', plot.garage);
			
			$('#farming').prop('checked', plot.farming);
			$('#orchard').prop('checked', plot.orchard);
			$('#grazing').prop('checked', plot.grazing);
		}
		
		var customLabel = {
			RENT: {
			  label: 'R'
			},
			SALE: {
			  label: 'S'
			}
		};
		
		function getPlots(){
			var json = '{\"plots":[{';
			// plot1:
			json+='\"title\":\"First plot title\",';
			json+='\"description\":\"First plot description\",';
			json+='\"address1\":\"First plot address 1\",';
			json+='\"address2\":\"First plot address 2\",';
			json+='\"district\":\"First plot district\",';
			json+='\"city\":\"First plot city\",';
			json+='\"country\":\"First plot country\",';
			json+='\"type\":\"RENT\",';
			json+='\"size\":\"24\",';
			json+='\"sizeUnit\":\"Ha\",';
			json+='\"price\":\"265\",';
			json+='\"currency\":\"USD\",';
			json+='\"house\":\"true\",';
			json+='\"power\":\"true\",';
			json+='\"water\":\"true\",';
			json+='\"sewer\":\"true\",';
			json+='\"vertices\":[';
			json+='{\"lat\": -33.863276, \"lng\": 151.207977},';
			json+='{\"lat\": -33.863276, \"lng\": 151.208977},';
			json+='{\"lat\": -33.864276, \"lng\": 151.208977},';
			json+='{\"lat\": -33.864276, \"lng\": 151.207977}';
			json+=']},{';
			// plot2:
			json+='\"title\":\"Second plot title\",';
			json+='\"description\":\"Second plot description\",';
			json+='\"address1\":\"Second plot address 1\",';
			json+='\"address2\":\"Second plot address 2\",';
			json+='\"district\":\"Second plot district\",';
			json+='\"city\":\"Second plot city\",';
			json+='\"country\":\"Second plot country\",';
			json+='\"type\":\"SALE\",';
			json+='\"size\":\"54\",';
			json+='\"sizeUnit\":\"Ar\",';
			json+='\"price\":\"265481\",';
			json+='\"currency\":\"EUR\",';
			json+='\"orchard\":\"true\",';
			json+='\"vertices\":[';
			json+='{\"lat\": -33.865276, \"lng\": 151.205977},';
			json+='{\"lat\": -33.865276, \"lng\": 151.206977},';
			json+='{\"lat\": -33.866276, \"lng\": 151.206977},';
			json+='{\"lat\": -33.866276, \"lng\": 151.205977}';
			json += ']}]}';
			return json;
		}
    </script>
    <script async defer 
		src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAnUcOUuCwexpeI5wIAZMkpK5LRYDAajgk&callback=initMap">
	</script>
  </body>
</html>